#!/usr/bin/env node
var collector = require('../');

var db = require('levelup')(process.argv[2]);

var stream = db.createReadStream({
  gt: 'cert/',
  lt: 'cert/z'
});

process.stdout.write('[');
process.on('exit', function() {
  process.stdout.write('\nnull]\n');
});

var pending = 0;

function runPending() {
  if (pending === 0)
    return;
  pending--;

  parallel();
}

stream.on('readable', runPending);

function parallel() {
  var pair = stream.read();
  if (!pair) {
    pending++;
    return;
  }

  // Slice off the `cert/`
  var hash = pair.key.slice(5);

  var ips = [];
  db.createReadStream({
    gt: 'map/' + cert + '/',
    lt: 'map/' + cert + '/z',
    key: true
  }).on('data', function(ip) {
    ips.push(ip);
  }).once('end', function() {
    var info = collector.extract(pair.value, ips);

    process.stdout.write('\n' + JSON.stringify(info) + ',');

    parallel();
  });
}

for (var i = 0; i < 1000; i++)
  parallel();
