#!/usr/bin/env node

var Collector = require('../');
var fs = require('fs');
var path = require('path');

var dir = path.resolve('.', 'certs');

try {
  fs.mkdirSync(dir);
} catch (e) {
}

function run(id) {
  var raw = Math.random() * 0xffffffff;
  var addr = '';
  for (var i = 0; i < 3; i++, raw >>>= 8)
    addr += (raw & 0xff) + '.';
  addr += raw;

  new Collector().collect(addr, function(err, cert) {
    if (err)
      return run(id);

    process.nextTick(function() {
      saveCert(addr, cert);
    });
    run(id);
  });
}

var parallel = 1000;
for (var i = 0; i < parallel; i++)
  run(i);

function saveCert(addr, cert) {
  process.stdout.write('.');
  fs.writeFile(path.resolve(dir, addr), cert, function(err) {
    if (err)
      console.error(err);
  });
}
