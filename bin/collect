#!/usr/bin/env node
var collector = require('../');
var cluster = require('cluster');
var os = require('os');
var ProgressBar = require('progress');

var bar;

var options = {
  parallel: 1000,
  workers: 4,
  db: './certs'
};

if (cluster.isMaster) {
  var master = new collector.Master(options);
  var totalCount = 0;

  master.getCount(function(err, count) {
    if (err)
      throw err;

    totalCount += count;
    master.start();
  });

  master.on('log', function(msg) {
    console.error(msg);
  });

  master.on('cert', function(cert) {
    totalCount++;

    if (bar && bar.curr >= bar.total) {
      bar.terminate();
      bar = null;
    }

    if (!bar) {
      bar = new ProgressBar(':bar :current/:total :eta', {
        total: totalCount + 10000,
        width: 80,
        clear: true
      });
    }

    bar.tick();
  });
} else {
  var worker = new collector.Worker(options);
}
